<div class="relative size-full overflow-auto" (scroll)="flushLoadMoreBtnWhenVisible()">
  @if (chats.loading()) {
  <app-spinner ariaLabel="Loading chats..." />
  } @else if (chats.loadError(); as _loadError) {
  <app-error-message [message]="_loadError" (retry)="chats.load()" />
  } @else {
  <!-- prettier-ignore -->
  @let _chatList = chats.list();
  <!-- prettier-ignore -->
  @if (_chatList.length > 0) {
  <p-menu
    [model]="_chatList"
    ariaLabel="Chat list"
    styleClass="rounded-none border-none"
    [pt]="{ list: { class: 'gap-0' } }"
  >
    <ng-template #item let-_chat>
      @let _title = chats.generateTitle(_chat, user());
      <a
        pRipple
        [title]="_title"
        ariaCurrentWhenActive="page"
        routerLinkActive="bg-highlight"
        [routerLink]="['/chats', _chat.id]"
        [routerLinkActiveOptions]="{ exact: true }"
        class="size-full py-4 px-2 border-surface border-b flex items-center"
      >
        <p-avatar
          label="{{ _title[0]?.toUpperCase() }}"
          class="shrink-0 me-2 text-center"
          shape="circle"
          size="large"
        />
        <span class="block grow w-[calc(100%-56px)] **:truncate">
          <span class="block w-full text-lg font-semibold tracking-wider">
            {{ _title || 'Anonymous' }}
          </span>
          <span class="block w-full text-muted-color text-sm font-light tracking-tighter">
            {{ _chat.messages[0]?.body || 'Empty chat!' }}
          </span>
        </span>
      </a>
    </ng-template>
    <ng-template #end>
      @if(chats.canLoadMore()) {
      <div class="text-center text-sm">
        @if(chats.loadingMore()) {
        <app-spinner ariaLabel="Loading more chats..." />
        } @else if (chats.loadMoreError(); as _loadMoreError) {
        <app-error-message [message]="_loadMoreError" (retry)="chats.loadMore()" />
        } @else {
        <button text outlined pButton pRipple #loadMoreBtn type="button" (click)="chats.loadMore()">
          Load more
        </button>
        }
      </div>
      }
    </ng-template>
  </p-menu>
  } @else {
  <p class="text-muted-color">There are no chats.</p>
  } }
</div>

@let _picking = picking();
@let _pickingImage = _picking === 'image';
@let _pickingEmoji = _picking === 'emoji';
@let _selectedColorScheme = colorScheme.selectedScheme().value;
@let _theme = _selectedColorScheme === 'system' ? 'auto' : _selectedColorScheme;
<form #messageForm [formGroup]="form" (ngSubmit)="submit()" aria-label="New Message"
      class="relative">
        <div aria-live="polite" aria-atomic="true"
             class="absolute top-0 left-0 w-full h-0 contain-layout">
                @if (_pickingEmoji || _pickingImage) {
                <div class="block overflow-auto absolute bottom-full left-1 right-1 pb-1"
                     animate.enter="animate-[slide-down_300ms_ease-in_reverse]"
                     animate.leave="animate-[slide-down_300ms_ease-in]">
                        @if (_pickingImage) {
                        <app-image-picker [progress]="progress()" [disabled]="form.disabled"
                                          (unpicked)="unpickImage()"
                                          (canceled)="togglePicker('image')"
                                          (picked)="pickedImage.set($event)" />
                        }@else {
                        <app-emoji-picker (picked)="appendPickedEmoji($event)" [theme]="_theme" />
                        }
                </div>
                }
        </div>
        <div class="bg-(--p-content-background) flex items-end relative p-2 space-x-2">
                <ng-container [ngTemplateOutlet]="btn" [ngTemplateOutletContext]="{
                        $implicit: {
                                label: `${_pickingImage ? 'Hide' : 'Show'} image picker`,
                                onClick: togglePicker.bind(this, 'image'),
                                icon: 'pi pi-camera',
                        }
                }" />
                <ng-container [ngTemplateOutlet]="btn" [ngTemplateOutletContext]="{
                        $implicit: {
                                label: `${_pickingEmoji ? 'Hide' : 'Show'} emoji picker`,
                                onClick: togglePicker.bind(this, 'emoji'),
                                icon: 'pi pi-face-smile',
                        }
                }" />
                <textarea #msgInp pTextarea rows="1" pSize="small" variant="filled"
                          id="message-body" [autoResize]="true" aria-label="Message"
                          formControlName="body" placeholder="Message..."
                          (onResize)="showScrollbarAsNeeded()" [class]="`grow align-middle max-h-[50vh] rounded-2xl
        text-sm font-semibold tracking-wider placeholder-shown:font-normal`"></textarea>
                <ng-container [ngTemplateOutlet]="btn" [ngTemplateOutletContext]="{ 
                                $implicit: { label: 'Send', type: 'submit', severity: 'primary', icon: 'pi pi-send' } 
                                }" />
        </div>
</form>
<ng-template #btn let-_props>
        <button pButton pRipple rounded size="small" type="{{ _props.type || 'button' }}"
                [severity]="_props.severity || 'secondary'" [disabled]="form.disabled"
                aria-label="{{_props.label}}" [icon]="_props.icon"
                (click)="_props.onClick?.()"></button>
</ng-template>